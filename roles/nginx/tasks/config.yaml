- name: "Remove unneded config dirs"
  file:
    status: absent
  loop:
    - "/etc/nginx/sites-enabled"
    - "/etc/nginx/sites-available"

- name: "Install nginx main config"
  template:
    src: "nginx.conf.j2"
    dest: "/etc/nginx/nginx.conf"
    owner: root
    group: root
    mode: 0644
  notify: "Reload nginx"

- name: "Install upstream configs"
  template:
    src: "upstream.conf.j2"
    dest: "/etc/nginx/conf.d/upstream_{{ item.name }}.conf"
    owner: root
    group: root
    mode: 0644
  loop: "{{ nginx_upstreams }}"
  notify: "Reload nginx"

- name: "Install vhost configs"
  template:
    src: "upstream.conf.j2"
    dest: "/etc/nginx/conf.d/vhost_{{ item.name }}.conf"
    owner: root
    group: root
    mode: 0644
  loop: "{{ nginx_vhosts }}"
  notify: "Reload nginx"
